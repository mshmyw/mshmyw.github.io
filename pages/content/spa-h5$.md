---
draft: false
author: ximenchuixue
title: spa
path: /spa
date: 2019-11-07 23:57:32
tags: ['spa原理和加载过程']
---

##传统多页面和SPA应用对比

多页面和SPA单页面简单理解就是：多页面应用需要加载多个页面，每次点击链接进入的都是一个新的页面；单页面应用就是只有一个HTML页面，哪怕点击一个链接进行了路由跳转。

```
+-------------------------+   +-------------------------+
|  +------------------+   |   |    +----------------+   |
|  |                  |   |   |    |                |   |
|  |      header      |   |   |    |     header     |   |
|  |                  |   |   |    |                |   |
|  +------------------+   |   |    +----------------+   |
|    +---------------+    |   |       +-------------+   |
|    |               |    |   |       |             |   |
|    |               |    |   |       |             |   |
|    |      page1    |    |   |       |   page2     |   |
|    |               |    |   |       |             |   |
|    |               |    |   |       |             |   |
|    |               |    |   |       |             |   |
|    +---------------+    |   |       |             |   |
|                         |   |       +-------------+   |
|   +----------------+    |   |    +----------------+   |
|   |                |    |   |    |       footer   |   |
|   |      footer    |    |   |    |                |   |
|   |                |    |   |    |                |   |
|   +----------------+    |   |    +----------------+   |
+-------------------------+   +-------------------------+
```

如上图，页面从page1到page2会重新加载包括header和footer在内的所有页面资源。

## 传统应用页面加载过程

## 何为传统应用页面

多页面，跳转会刷新所有资源，每个公共资源(js、css等)需选择性重新加载。

## 传统应用页面加载过程

## 原理

# 现代SPA应用页面加载过程

## 何为SPA

 single-page application即单页应用。简单理解就是，一个web应用或网站只有一个HTML页面。

> 原理上说就是：将所有的活动局限于一个Web页面中，仅在该Web页面初始化时加载相应的HTML、JavaScript 和 CSS。一旦页面加载完成了，SPA不会因为用户的操作而进行页面的重新加载或跳转。而是利用 JS和路由机制动态的变换HTML的内容，从而实现UI与用户的交互。避免页面的重新加载。

由于避免了页面的重新加载，SPA 可以提供较为流畅的用户体验。得益于ajax，我们可以实现无跳转刷新，又多亏了**浏览器的histroy机制**，我们用hash的变化从而可以实现推动界面变化。

这怎么可能呢？一个网站肯定有很多内容，那页面跳转怎么办呢？

别急。

单页应用大概是这样的：首先上面的HTML页面其实一个页面容器，页面要展示的内容，就放在该容器里。那么这些内容是如何组织划分的呢？其实是将所有页面内容分成很多块（组件），这些组件可被重复利用，相互独立，当需要加载某个组件时，JS就动态创建这些组件里的HTML以及CSS等。

```
+------------------------------------------------+
|----------+ +-----------------------------------|
||         | |                                  ||
||         | |              header              ||
||         | |                                  ||
||         | +-----------------------------------+
||         |                                     |
||         |   +---------+   +---------+         |
||         |   |         |   |         |         |
||         |   |         |   |         |         |
||         |   |         |   |         |         |
||sidebar  |   |  page1  |   |   page2 |         |
||         |   |         |   |         |         |
||         |   |         |   |         |         |
||         |   |         |   |         |         |
||         |   +---------+   +---------+         |
||         |                                     |
||         | +-----------------------------------+
||         | |                                  ||
||         | |            footer                ||
||         | |                                  ||
||         | |                                  ||
|----------+ +-----------------------------------|
+------------------------------------------------+
```

如上图所示，当页面从page1跳转到page2时，需要替换的页面结构仅仅是内容区的page2，页面其他部分并未变化。

总结一下，单页应用特点：

1. 只有一个HTML页面
2. 单页面跳转仅刷新局部资源
3. 公共资源(js、css等)仅需加载一次

## SPA应用好处

SPA应用的好处也就是传统多页面应用的坏处，多页面应用的坏处是什么呢？那就是每次进入新的页面，都需要向服务器发送请求，要整个页面的所有代码，而且，多次操作后，哪怕是再次进入相同页面，还是得再次请求。这样会浪费网络流量，最重要是用户体验很差，很不友好。

而单页应用，是一次性将web应用的所有代码（HTML，JS，CSS）全部请求过来（首屏加载太慢的话可能要按需加载）。这样，以后用户的每一个动作都不会重新加载页面（不需要再次向服务器请求页面的HTML、JS、CSS）。取而代之的是利用JS动态的替换HTML的内容，而这个过程不需要再和服务器交互，除非数据是动态的，那此时只需要向服务器要数据即可）。这就比传统多页面加载要高效的多了！

SPA也并非全是好处，例如搜索引擎优化（SEO）就相比传统多页面要困难。

总结下[优点](https://www.jianshu.com/p/6edb09b0d14a)：

 1）良好的交互体验-》前端进行的是局部渲染，避免了不必要的跳转和重复渲染；

​     2）前后端职责分离，架构清晰-》前端进行交互逻辑，后端负责数据处理；

​     3）减轻服务器压力-》服务器只用出数据就可以，不用管展示逻辑和页面合成；

缺点：

 *1）初次加载耗时多-》*为实现单页Web应用功能及显示效果，需要在加载页面的时候将JavaScript、CSS统一加载，部分页面按需加载；

> 解决方案：使用模块化框架，按需加载资源，

2）前进后退路由管理-》由于单页应用在一个页面中显示所有的内容，所以不能使用浏览器的前进后退功能，所有的页面切换需要自己建立堆栈管理；

> 解决方案：使用原生H5 History API，如window.history.replaceState和window.history.pushState；

3）SEO难度较大-》由于所有的内容都在一个页面中动态替换显示，所以在SEO上其有着天然的弱势；

## [SPA加载过程](https://juejin.im/post/5b506ae0e51d45191a0d4ec9)

1. 用户打开页面，这个时候页面空白，因为此时只有容器页面，而容器页面只是一个骨架，并没有任何实质内容，其大致内容如下：

   ```
   <!DOCTYPE html>
   <html lang="zh-CN">
     <head>
       <meta charset="utf-8">
       <title>Iam professor</title>
       <link rel="shortcut icon" type="image/png" href="assets/favicon.png"/>
       <base href="<!--# echo var='base_href' default='/' -->">
     <link href="main.2c4cb809c42d670d0106.css" rel="stylesheet"></head>
     <body>
       <div id="root-layout">
         <nav id="menu-bar-mount-point" class="print-hide"></nav>
         <div id="root-content">
           <header id="app-bar-mount-point" class="print-hide"></header>
           <div id="main-mount-point"></div>
           <div id="legacy-iframe-mount-point"></div>
         </div>
         <div id="loading-bar-mount-point"></div>
       </div>
       <div id="bg-mount-point"></div>
   <script type="text/javascript" src="main.04a0a4be17b0fe29ba4c.js"></script></body>
   </html>

   ```

   2. html和引用的css加载完后，浏览器进行**首次渲染**
   3. react、react-dom、业务代码加载完毕，应用进行**首次内容渲染**。
   4. 应用代码开始执行 ，拉取数据、进行动态import、响应事件等等，完毕后页面进入**可交互**状态；
   5. 接下来 lazyload 的图片等多媒体内容开始逐渐加载完毕；
   6. 然后直到页面的其它资源（如错误上报组件、打点上报组件等）加载完毕，整个页面的加载就结束了。

### 首屏渲染优化

spa第一次渲染需要拉取网站所有页面内容（HTML、JS、CSS），所以导致首屏渲染很慢，可能出现一段时间不可忍受的白屏，那么如何优化进而提升用户体验呢？

1 针对首次渲染：

加入loading状态 缓解用户焦虑

2 针对首次内容渲染：

这一段过程中，浏览器主要在做的事情就是加载、运行 JS 代码，所以如何提升 JS 代码的加载、运行性能，就成为了优化的关键。

几乎所有业务的 JS 代码，都可以大致划分成以下几个大块：

- **基础框架**，如 React、Vue 等，这些基础框架的代码是不变的，除非升级框架；

- **Polyfill**，对于使用了 ES2015+ 语法的项目来说，为了兼容性，polyfill 是必要的存在；

- **业务基础库**，业务的一些通用的基础代码，不属于框架，但大部分业务都会使用到；

- **业务代码**，特点是具体业务自身的逻辑代码。

想要优化这个时间段的性能，也就是要优化上面四种资源的加载速度。

1) 缓存基础框架

基础框架代码的特点就是**必需**且**不变**，是一种非常适合缓存的内容。

所以我们需要做的就是**为基础框架代码设置一个尽量长的缓存时间**，使用户的浏览器尽量通过缓存加载这些资源。

2) 使用动态 polyfill

Polyfill 的特点是**非必需**和**不变**，因为对于一台手机来说，需要哪些 polyfill 是固定的，当然也可能完全不需要 polyfill。

3) 使用 SplitChunksPlugin 自动拆分业务基础库

SplitChunksPlugin 采用了完全不同的 heuristics 方法，它会根据模块之间的依赖关系，自动打包出很多很多（而不是单个）通用模块，可以保证加载进来的代码一定是会被依赖到的

4) 正确使用 Tree Shaking 减少业务代码体积

3 针对首次内容渲染-> 可交互阶段

这一段过程中，浏览器主要在做的事情就是**加载及初始化各项组件**

大多数打包器（比如 webpack、rollup、browserify）的作用就是把你的页面代码打包成一个很大的 “bundle”，所有的代码都会在这个 bundle 中。但是，随着应用的复杂度日益提高，bundle 的体积也会越来越大，加载 bundle 的时间也会变长，这就对加载过程中的用户体验造成了很大的负面影响。

为了避免打出过大的 bundle，我们要做的就是切分代码，也就是 [Code Splitting](https://webpack.js.org/guides/code-splitting/)，目前几乎所有的打包器都原生支持这个特性。

Code Splitting 可以帮你“懒加载”代码，以提高用户的加载体验，如果你没办法直接减少应用的体积，那么不妨尝试把应用从单个 bundle 拆分成单个 bundle + 多份动态代码的形式。比如react的`React Loadable`

3.1 编译到 ES2015+ ，提升代码运行效率

在当下 2018 年，对于大部分用户而言，我们根本不需要把代码编译到 ES5，不仅体积大，而且运行速度慢。**我们需要做的，就是把代码编译到 ES2015+，然后为少数使用老旧浏览器的用户保留一个 ES5 标准的备胎即可。**

4 可交互 -> 内容加载完毕

这个阶段就很简单了，主要是各种多媒体内容的加载

4.1 懒加载 [react-lazyload](https://github.com/jasonslyvia/react-lazyload),

实际上目前几乎所有 lazyload 组件都不外乎以下两种原理：

- 监听 window 对象或者父级对象的 scroll 事件，触发 load；
- 使用 [Intersection Observer API](https://caniuse.com/#feat=intersectionobserver) 来获取元素的可见性。

4.2 placeholder

我们在加载文本、图片的时候，经常出现“闪屏”的情况，比如图片或者文字还没有加载完毕，此时页面上对应的位置还是完全空着的，然后加载完毕，内容会突然撑开页面，导致“闪屏”的出现，造成不好的体验。

为了避免这种突然撑开的情况，我们要做的就是提前设置占位元素，也就是 placeholder

## SPA原理

SPA原理涉及前端路由和框架。

## 代表性框架

单页应用的页面不再是静态的了，而是要借助JS完成页面内容的替换。这也使得JS的用途更重要，也由此催生了很多框架，目前最具代表性的是React/Vue/Angular

## 总结（首屏优化）

在 HTML 内实现 Loading 态或者骨架屏；

去掉外联 css；

缓存基础框架；

使用动态 polyfill；

使用 SplitChunksPlugin 拆分公共代码；

正确地使用 Webpack 4.0 的 Tree Shaking；

使用动态 import，切分页面代码，减小首屏 JS 体积；

编译到 ES2015+，提高代码运行效率，减小体积；

使用 lazyload 和 placeholder 提升加载体验。
